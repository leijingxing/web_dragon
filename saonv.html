<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŸç¥ - ã€Œå°‘å¥³ã€å“¥ä¼¦æ¯”å¨… | æœ€ç»ˆä¿®å¤ç‰ˆ</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: "Segoe UI", sans-serif; }
        
        /* UI è¦†ç›–å±‚ */
        #ui-container {
            position: absolute; top: 20px; left: 20px; color: #eee; pointer-events: none;
            text-shadow: 0 0 5px rgba(0,0,0,0.8);
        }
        h1 { margin: 0; font-weight: 300; letter-spacing: 2px; color: #fff; }
        p { margin: 5px 0; color: #aaa; font-size: 0.9rem; }
        
        /* åŠ è½½åŠ¨ç”» */
        #loader {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; width: 100%;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #fff;
            border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        #status { color: #fff; letter-spacing: 1px; }
        #error-msg { color: #ff4444; margin-top: 10px; white-space: pre-wrap; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "lil-gui": "https://unpkg.com/lil-gui@0.19.1/dist/lil-gui.esm.min.js"
            }
        }
    </script>
</head>
<body>

    <div id="ui-container">
        <h1>DAMSELETTE</h1>
        <p>Genshin Impact â€¢ Fatui Harbingers</p>
        <p style="font-size: 0.8rem; opacity: 0.6;">æè´¨å…¨ç™½ä¿®å¤å®Œæˆ â€¢ äº¤äº’å¼æ¸²æŸ“</p>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <div id="status">æ­£åœ¨åˆå§‹åŒ–å¼•æ“...</div>
        <div id="error-msg"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        let scene, camera, renderer, controls, mixer, model, composer;
        const clock = new THREE.Clock();
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error-msg');

        init();

        function init() {
            // 1. åœºæ™¯è®¾ç½®
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050505);
            // åŠ ä¸Šä¸€ç‚¹ç´«è‰²é›¾æ°”ï¼Œé…åˆå“¥ä¼¦æ¯”å¨…çš„é…è‰²
            scene.fog = new THREE.FogExp2(0x1a0b2e, 0.02);

            // 2. æ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // ç”µå½±çº§è‰²è°ƒæ˜ å°„ (è®©é¢œè‰²ä¸é‚£ä¹ˆç”Ÿç¡¬)
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.2;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // 3. ç›¸æœº
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(0, 1.4, 3.5);

            // 4. å…‰ç…§ç³»ç»Ÿ (ä¸ºäº†è®©æè´¨æ˜¾è‰²ï¼Œå…‰ç…§å¿…é¡»æŸ”å’Œ)
            const environment = new RoomEnvironment(renderer);
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            scene.environment = pmremGenerator.fromScene(environment).texture;

            // ä¸»å…‰
            const mainLight = new THREE.DirectionalLight(0xffffff, 2.0);
            mainLight.position.set(2, 5, 5);
            mainLight.castShadow = true;
            scene.add(mainLight);

            // è½®å»“å…‰ (ç´«è‰²ï¼Œå¢åŠ ç¥ç§˜æ„Ÿ)
            const rimLight = new THREE.SpotLight(0xa020f0, 5);
            rimLight.position.set(-3, 2, -3);
            scene.add(rimLight);

            // 5. åæœŸå¤„ç† (Bloom è¾‰å…‰)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.strength = 0.3; // ç¨å¾®å‘å…‰å³å¯ï¼Œå¤ªå¼ºä¼šç™½
            bloomPass.radius = 0.5;
            bloomPass.threshold = 0.8;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // 6. åŠ è½½æ¨¡å‹ (å«ä¿®å¤é€»è¾‘)
            loadModel();

            // 7. æ§åˆ¶å™¨
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 0.8, 0);

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function loadModel() {
            const loader = new GLTFLoader();
            
            // è®¾ç½® Draco è§£ç å™¨ (è§£å†³å‹ç¼©æ¨¡å‹åŠ è½½å¤±è´¥é—®é¢˜)
            const dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/gltf/');
            loader.setDRACOLoader(dracoLoader);

            statusDiv.innerText = "æ­£åœ¨ä¸‹è½½æ¨¡å‹æ•°æ®...";

            loader.load(
                'columbina_rigged_free.glb', // ç¡®ä¿æ–‡ä»¶åå®Œå…¨ä¸€è‡´
                (gltf) => {
                    statusDiv.innerText = "æ­£åœ¨å¤„ç†æè´¨...";
                    model = gltf.scene;

                    // === ğŸš¨ ç»ˆæä¿®å¤å…¨ç™½é—®é¢˜çš„æ ¸å¿ƒä»£ç  ğŸš¨ ===
                    model.traverse((child) => {
                        if (child.isMesh && child.material) {
                            child.castShadow = true;
                            child.receiveShadow = true;

                            // 1. ã€å…³é”®ã€‘æ€æ­»è‡ªå‘å…‰ã€‚åŸç¥æ¨¡å‹å¸¸æŠŠè¿™ä¸ªè®¾ä¸ºç™½è‰²ï¼Œå¯¼è‡´å…¨ç™½ã€‚
                            // åªæœ‰å½“æè´¨çœŸçš„æœ‰ emissiveMap æ—¶æ‰ä¿ç•™ä¸€ç‚¹ç‚¹
                            if (!child.material.emissiveMap) {
                                child.material.emissive = new THREE.Color(0x000000); 
                                child.material.emissiveIntensity = 0;
                            } else {
                                // å¦‚æœæœ‰å‘å…‰è´´å›¾ï¼ˆç¥ä¹‹çœ¼ï¼‰ï¼Œé‡ç½®ä¸ºç™½è‰²ä½†å¼ºåº¦é€‚ä¸­
                                child.material.emissive = new THREE.Color(0xffffff);
                                child.material.emissiveIntensity = 1.0;
                            }

                            // 2. ã€å…³é”®ã€‘æ¶ˆé™¤é‡‘å±æ„Ÿã€‚äºŒæ¬¡å…ƒè§’è‰²ä¸æ˜¯é“åšçš„ã€‚
                            child.material.metalness = 0.0;

                            // 3. ã€å…³é”®ã€‘å¢åŠ ç²—ç³™åº¦ã€‚é˜²æ­¢åƒé•œå­ä¸€æ ·åå…‰ã€‚
                            child.material.roughness = 0.9; 

                            // 4. ç¡®ä¿è´´å›¾è‰²å½©æ­£ç¡®
                            if (child.material.map) {
                                child.material.map.colorSpace = THREE.SRGBColorSpace;
                            }
                            
                            // 5. åŒé¢æ¸²æŸ“ï¼ˆé˜²æ­¢è£™å­å†…ä¾§é€æ˜ï¼‰
                            child.material.side = THREE.DoubleSide;
                        }
                    });
                    // === ä¿®å¤ç»“æŸ ===

                    // è‡ªåŠ¨ç¼©æ”¾ä¸å±…ä¸­
                    const box = new THREE.Box3().setFromObject(model);
                    const size = box.getSize(new THREE.Vector3());
                    const maxDim = Math.max(size.x, size.y, size.z);
                    if (maxDim > 0) {
                        const scale = 2.5 / maxDim; 
                        model.scale.setScalar(scale);
                        const newBox = new THREE.Box3().setFromObject(model);
                        const center = newBox.getCenter(new THREE.Vector3());
                        model.position.sub(center);
                        model.position.y += 0.8; // è°ƒæ•´é«˜åº¦
                    }

                    scene.add(model);

                    // æ’­æ”¾åŠ¨ç”»
                    if (gltf.animations && gltf.animations.length > 0) {
                        mixer = new THREE.AnimationMixer(model);
                        // æ’­æ”¾æ‰€æœ‰åŠ¨ç”»è½¨é“
                        gltf.animations.forEach(clip => {
                            mixer.clipAction(clip).play();
                        });
                    }

                    document.getElementById('loader').style.display = 'none';
                },
                (xhr) => {
                    const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                    statusDiv.innerText = `åŠ è½½ä¸­... ${percent}%`;
                },
                (error) => {
                    console.error(error);
                    statusDiv.innerText = "âŒ åŠ è½½å¤±è´¥";
                    errorDiv.innerText = "1. è¯·ç¡®ä¿æ–‡ä»¶åå®Œå…¨ä¸€è‡´: columbina_rigged_free.glb\n2. è¯·æŒ‰ F12 æŸ¥çœ‹æ§åˆ¶å°è¯¦ç»†é”™è¯¯\n3. è¯·åŠ¡å¿…ä½¿ç”¨ Live Server è¿è¡Œ";
                }
            );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
        }


        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            controls.update();
            // è‡ªåŠ¨ç¼“æ…¢æ—‹è½¬
            if(model) model.rotation.y += 0.002;
            composer.render();
        }
    </script>
</body>
</html>