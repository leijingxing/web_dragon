<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Gallery - 珍藏阁</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;700&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a1a1a; font-family: 'Noto Serif SC', serif; color: #fff; }
        
        #sidebar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 250px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-sizing: border-box;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            overflow-y: auto;
            transform: translateX(0);
            transition: transform 0.3s ease;
        }

        #sidebar.collapsed {
            transform: translateX(-100%);
        }

        h2 {
            margin-top: 0;
            font-weight: 300;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
            letter-spacing: 2px;
        }

        .model-item {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            color: #ccc;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 4px;
            font-family: inherit;
        }

        .model-item:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
        }

        .model-item.active {
            background: rgba(212, 175, 55, 0.2);
            border-color: rgba(212, 175, 55, 0.5);
            color: #ffd700;
        }

        #toggle-btn {
            position: absolute;
            left: 250px;
            top: 20px;
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            z-index: 11;
            transition: left 0.3s ease;
            border-radius: 0 4px 4px 0;
        }
        
        #sidebar.collapsed + #toggle-btn {
            left: 0;
        }

        #viewer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 1;
            background: radial-gradient(circle at center, #2b2b2b 0%, #1a1a1a 100%);
        }

        #loading {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            pointer-events: none;
            font-size: 1.2em;
            letter-spacing: 3px;
        }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            text-align: right;
            pointer-events: none;
            opacity: 0.7;
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="sidebar">
        <h2>模型库 Gallery</h2>
        <div id="model-list">
            <!-- JS will populate this -->
        </div>
    </div>
    <button id="toggle-btn">☰</button>

    <div id="loading">选择模型以查看...</div>
    
    <div class="info-panel">
        <p>左键旋转 | 右键平移 | 滚轮缩放</p>
    </div>

    <div id="viewer"></div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';

        // --- 配置：在这里添加新模型 ---
        const models = [
            { name: "凤凰 (Phoenix)", path: "phoenix_bird.glb" },
            { name: "雪龙 (Snow Dragon)", path: "snow_dragon.glb" },
            { name: "少女 (Columbina)", path: "columbina_rigged_free.glb" },
            { name: "芙宁娜 (Furina)", path: "genshin_impact_furina.glb" }
        ];

        let scene, camera, renderer, controls, mixer;
        let currentModel = null;
        // 程序化动画对象
        let proceduralBones = { head: null, spine: null, neck: null };
        let isProceduralActive = false;
        
        const clock = new THREE.Clock();

        init();
        animate();

        function init() {
            // UI Setup
            const list = document.getElementById('model-list');
            models.forEach((m, index) => {
                const btn = document.createElement('button');
                btn.className = 'model-item';
                btn.innerText = m.name;
                btn.onclick = () => loadModel(m.path, btn);
                list.appendChild(btn);
                
                // 默认加载第一个
                if(index === 0) btn.click();
            });

            document.getElementById('toggle-btn').onclick = () => {
                document.getElementById('sidebar').classList.toggle('collapsed');
            };

            // 3D Setup
            const container = document.getElementById('viewer');
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            scene = new THREE.Scene();
            
            // 使用 PMREMGenerator 生成高质量环境光，无需手动打灯，展示模型最方便
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

            // 辅助网格
            const grid = new THREE.GridHelper(20, 20, 0x444444, 0x222222);
            scene.add(grid);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
            camera.position.set(5, 2, 5);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            window.addEventListener('resize', onResize);
        }

        function loadModel(path, btnElement) {
            // UI State
            document.querySelectorAll('.model-item').forEach(b => b.classList.remove('active'));
            if(btnElement) btnElement.classList.add('active');

            const loaderDiv = document.getElementById('loading');
            loaderDiv.style.display = 'block';
            loaderDiv.innerText = "正在加载 " + path + "...";

            // Cleanup old model
            if (currentModel) {
                scene.remove(currentModel);
                if(mixer) mixer.stopAllAction();
                mixer = null;
                currentModel = null;
                // 重置程序化动画状态
                proceduralBones = { head: null, spine: null, neck: null };
                isProceduralActive = false;
            }

            const loader = new GLTFLoader();
            loader.load(path, (gltf) => {
                currentModel = gltf.scene;

                // Auto Scale & Center
                const box = new THREE.Box3().setFromObject(currentModel);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                
                // 归一化缩放：让模型最大边长约为 4
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 4.0 / maxDim;
                
                currentModel.scale.setScalar(scale);
                // 居中到底部 (y=0)
                currentModel.position.x = -center.x * scale;
                currentModel.position.y = -box.min.y * scale; // 让脚底贴地
                currentModel.position.z = -center.z * scale;
                
                // 保存初始 Y 供漂浮动画使用
                currentModel.userData.baseY = currentModel.position.y;

                scene.add(currentModel);

                // Animation Strategy
                if (gltf.animations && gltf.animations.length > 0) {
                    // 1. 优先使用自带动画
                    mixer = new THREE.AnimationMixer(currentModel);
                    const action = mixer.clipAction(gltf.animations[0]);
                    action.play();
                    loaderDiv.innerText = "加载完成 (自带动画)";
                } else {
                    // 2. 如果没有动画，尝试程序化驱动骨骼
                    setupProceduralAnimation(currentModel);
                    if (isProceduralActive) {
                        loaderDiv.innerText = "加载完成 (智能驱动已激活)";
                    } else {
                        loaderDiv.innerText = "加载完成 (静态模型)";
                    }
                }

                setTimeout(() => { loaderDiv.style.display = 'none'; }, 2000);

            }, (xhr) => {
                const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
                loaderDiv.innerText = `加载中... ${percent}%`;
            }, (error) => {
                console.error(error);
                loaderDiv.innerText = "加载失败: " + path;
            });
        }

        // --- 智能骨骼绑定 ---
        function setupProceduralAnimation(model) {
            model.traverse((obj) => {
                if (obj.isBone) {
                    const name = obj.name.toLowerCase();
                    // 模糊匹配常见骨骼名称
                    if (name.includes('head') || name.includes('tou')) proceduralBones.head = obj;
                    else if (name.includes('neck') || name.includes('bozi')) proceduralBones.neck = obj;
                    else if ((name.includes('spine') || name.includes('body')) && !name.includes('2')) proceduralBones.spine = obj;
                }
            });

            // 只要找到任意一个关键骨骼，就激活程序化动画
            if (proceduralBones.head || proceduralBones.spine) {
                isProceduralActive = true;
                console.log("Procedural Animation Activated for:", proceduralBones);
            }
        }

        // --- 实时驱动 ---
        function updateProceduralAnimation(time) {
            if (!currentModel) return;

            // 1. 整体呼吸式悬浮 (Floating)
            // 让模型轻微上下浮动，模拟呼吸时的重心变化
            currentModel.position.y = currentModel.userData.baseY + Math.sin(time) * 0.05;

            // 2. 脊柱呼吸 (Spine Breath)
            if (proceduralBones.spine) {
                // 绕 X 轴微弱旋转 (前后呼吸)
                proceduralBones.spine.rotation.x = Math.sin(time * 2) * 0.03;
                // 绕 Y 轴微弱旋转 (身体自然摆动)
                proceduralBones.spine.rotation.y = Math.sin(time * 1) * 0.03;
            }

            // 3. 头部注视 (Head Look)
            // 让头部做非常缓慢的“环顾四周”运动
            if (proceduralBones.head) {
                proceduralBones.head.rotation.y = Math.sin(time * 0.5) * 0.3; // 左右看
                proceduralBones.head.rotation.x = Math.sin(time * 0.3) * 0.05; // 上下微动
            } else if (proceduralBones.neck) {
                // 如果没找到头，动脖子
                proceduralBones.neck.rotation.y = Math.sin(time * 0.5) * 0.2;
            }
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            const time = clock.getElapsedTime();

            if (mixer) {
                mixer.update(delta);
            } else if (isProceduralActive) {
                // 如果没有 Mixer，执行程序化动画
                updateProceduralAnimation(time);
            }

            controls.update();
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
