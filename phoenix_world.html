<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phoenix World - å…ƒå®‡å®™æ¼«æ¸¸</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000;
            font-family: 'Noto Serif SC', serif;
            user-select: none;
        }

        /* çœŸå®èƒŒæ™¯å±‚ - ä½œä¸ºè¿œæ™¯å¤©ç©ºç›’ */
        #bg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 1s ease-in-out;
            z-index: 0;
            /* åˆå§‹èƒŒæ™¯ï¼šé›ªå±± */
            background-image: url('https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070&auto=format&fit=crop');
        }

        /* è¦†ç›–å±‚ */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2);
            transition: background 1s;
            z-index: 1;
            pointer-events: none;
        }

        /* Canvas å±‚ */
        canvas {
            position: absolute;
            top: 0; left: 0;
            z-index: 2;
            outline: none;
        }

        /* UI */
        #ui-container {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 15px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            padding: 15px 30px;
            border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .scene-btn {
            background: transparent;
            border: none;
            color: #fff;
            font-family: 'Noto Serif SC', serif;
            font-size: 1rem;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0.7;
        }

        .scene-btn:hover {
            opacity: 1;
            background: rgba(255,255,255,0.1);
        }

        .scene-btn.active {
            opacity: 1;
            background: #fff;
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 15px rgba(255,255,255,0.4);
        }

        .btn-icon {
            font-size: 1.2rem;
        }

        #title {
            position: absolute;
            top: 40px;
            left: 40px;
            z-index: 10;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        h1 {
            font-family: 'Cinzel', serif;
            margin: 0;
            font-size: 2.5rem;
            letter-spacing: 5px;
        }
        p {
            margin: 5px 0 0 0;
            font-size: 0.9rem;
            opacity: 0.8;
            letter-spacing: 2px;
        }

        #controls-hint {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #ccc;
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
        }

        #loader {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            color: white;
            font-family: 'Cinzel', serif;
            font-size: 1.5rem;
            text-align: center;
        }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="bg-layer"></div>
    <div id="overlay"></div>

    <div id="title">
        <h1>PHOENIX WORLD</h1>
        <p>Metaverse Exploration</p>
        <div id="controls-hint">WSAD æˆ– ç®­å¤´é”®ç§»åŠ¨ â€¢ é¼ æ ‡æ‹–æ‹½æ—‹è½¬è§†è§’</div>
    </div>

    <div id="ui-container">
        <button class="scene-btn active" onclick="changeScene('snow')">
            <span class="btn-icon">â„ï¸</span> é›ªåŸŸç¥å±±
        </button>
        <button class="scene-btn" onclick="changeScene('city')">
            <span class="btn-icon">ğŸŒƒ</span> éœ“è™¹éƒ½å¸‚
        </button>
        <button class="scene-btn" onclick="changeScene('forest')">
            <span class="btn-icon">ğŸŒ¿</span> è¿·é›¾æ£®æ—
        </button>
        <button class="scene-btn" onclick="changeScene('volcano')">
            <span class="btn-icon">ğŸŒ‹</span> å†°å²›ç†”å²©
        </button>
    </div>

    <div id="loader">SUMMONING...</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        let scene, camera, renderer, controls;
        let phoenix, mixer;
        let dirLight, ambientLight, hemiLight;
        let ground, gridHelper;
        const clock = new THREE.Clock();

        // ç§»åŠ¨æ§åˆ¶çŠ¶æ€
        const keys = { w: false, a: false, s: false, d: false, shift: false };
        const playerState = {
            speed: 0,
            maxSpeed: 15.0,
            acceleration: 30.0,
            deceleration: 20.0,
            rotationSpeed: 3.0
        };

        // åœºæ™¯é…ç½®æ•°æ®
        const SCENES = {
            snow: {
                bg: 'https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2070&auto=format&fit=crop',
                ambient: 0xccccff,
                dirColor: 0xffffff,
                fog: 0xaaccff,
                fogDensity: 0.02,
                groundColor: 0xffffff,
                overlay: 'rgba(0,20,40,0.2)'
            },
            city: {
                bg: 'https://images.unsplash.com/photo-1519501025264-65ba15a82390?q=80&w=2000&auto=format&fit=crop',
                ambient: 0xaa00ff,
                dirColor: 0x00aaff,
                fog: 0x110022,
                fogDensity: 0.03,
                groundColor: 0x111111,
                overlay: 'rgba(20,0,40,0.4)'
            },
            forest: {
                bg: 'https://images.unsplash.com/photo-1448375240586-dfd8f3793371?q=80&w=2000&auto=format&fit=crop',
                ambient: 0x228822,
                dirColor: 0xffddaa,
                fog: 0x002200,
                fogDensity: 0.025,
                groundColor: 0x1a2e1a,
                overlay: 'rgba(0,20,0,0.3)'
            },
            volcano: {
                bg: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2000&auto=format&fit=crop',
                ambient: 0x440000,
                dirColor: 0xff4400,
                fog: 0x220000,
                fogDensity: 0.03,
                groundColor: 0x1a0a0a,
                overlay: 'rgba(40,10,0,0.3)'
            }
        };

        init();
        animate();

        function init() {
            // 1. è®¾ç½®åœºæ™¯
            scene = new THREE.Scene();
            // å¯ç”¨é›¾æ•ˆï¼Œè¥é€ æ·±åº¦æ„Ÿï¼Œéšè—åœ°é¢è¾¹ç•Œ
            scene.fog = new THREE.FogExp2(0xaaccff, 0.02);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);

            // 2. ç›¸æœº
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 500);
            camera.position.set(0, 5, -8); // åˆå§‹ä½ç½®åœ¨å‡¤å‡°èº«å

            // 3. ç¯å…‰ç³»ç»Ÿ
            ambientLight = new THREE.AmbientLight(0xccccff, 0.6);
            scene.add(ambientLight);

            hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.5);
            scene.add(hemiLight);

            dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(20, 50, 20);
            dirLight.castShadow = true;
            dirLight.shadow.camera.top = 50;
            dirLight.shadow.camera.bottom = -50;
            dirLight.shadow.camera.left = -50;
            dirLight.shadow.camera.right = 50;
            dirLight.shadow.camera.near = 0.1;
            dirLight.shadow.camera.far = 200;
            dirLight.shadow.mapSize.width = 2048;
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // 4. åœ°é¢ (æ²‰æµ¸å¼ - ä»…æ˜¾ç¤ºé˜´å½±)
            const planeGeometry = new THREE.PlaneGeometry(2000, 2000);
            const planeMaterial = new THREE.ShadowMaterial({ 
                opacity: 0.5
            });
            ground = new THREE.Mesh(planeGeometry, planeMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.position.y = -2; // è®©å‡¤å‡°æ‚¬æµ®åœ¨ç©ºä¸­ä¸€ç‚¹
            ground.receiveShadow = true;
            scene.add(ground);

            // ç½‘æ ¼è¾…åŠ©ï¼Œå¢å¼ºç©ºé—´æ„Ÿ (è°ƒæ•´å¾—æ›´æ·¡ï¼Œä»…ä½œä¸ºåœ°å¹³çº¿å‚è€ƒ)
            gridHelper = new THREE.GridHelper(2000, 400, 0xffffff, 0xffffff);
            gridHelper.position.y = -1.9;
            gridHelper.material.transparent = true;
            gridHelper.material.opacity = 0.1; // ææ·¡
            scene.add(gridHelper);


            // 5. åŠ è½½æ¨¡å‹
            const loader = new GLTFLoader();
            loader.load('phoenix_bird.glb', (gltf) => {
                phoenix = gltf.scene;

                const box = new THREE.Box3().setFromObject(phoenix);
                const size = box.getSize(new THREE.Vector3());
                const scale = 3.0 / Math.max(size.x, size.y, size.z);
                phoenix.scale.setScalar(scale);
                
                phoenix.traverse(c => {
                    if(c.isMesh) {
                        c.castShadow = true;
                        c.receiveShadow = true;
                        c.material.metalness = 0.4;
                        c.material.roughness = 0.5;
                        c.material.envMapIntensity = 1.0;
                    }
                });

                scene.add(phoenix);

                // åŠ¨ç”»
                mixer = new THREE.AnimationMixer(phoenix);
                if(gltf.animations.length > 0) {
                    const action = mixer.clipAction(gltf.animations[0]);
                    action.timeScale = 0.8; 
                    action.play();
                }

                document.getElementById('loader').style.display = 'none';
            });

            // 6. æ§åˆ¶å™¨ (ç”¨äºé¼ æ ‡æ—‹è½¬è§†è§’)
            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.enablePan = false;
            controls.minDistance = 5;
            controls.maxDistance = 20;
            controls.maxPolarAngle = Math.PI / 2 - 0.05; // é˜²æ­¢ç©¿åœ°
            
            // 7. äº‹ä»¶ç›‘å¬
            window.addEventListener('resize', onResize);
            window.changeScene = changeScene;

            document.addEventListener('keydown', (e) => onKey(e, true));
            document.addEventListener('keyup', (e) => onKey(e, false));

            // åˆå§‹åŒ–ç¬¬ä¸€ä¸ªåœºæ™¯
            changeScene('snow');
        }

        function onKey(e, pressed) {
            const key = e.key.toLowerCase();
            switch(key) {
                case 'w': case 'arrowup': keys.w = pressed; break;
                case 'a': case 'arrowleft': keys.a = pressed; break;
                case 's': case 'arrowdown': keys.s = pressed; break;
                case 'd': case 'arrowright': keys.d = pressed; break;
                case 'shift': keys.shift = pressed; break;
            }
        }

        function changeScene(type) {
            const config = SCENES[type];
            if(!config) return;

            // UI
            document.querySelectorAll('.scene-btn').forEach(btn => {
                btn.classList.remove('active');
                // Check if this button is the one for the current type
                if (btn.getAttribute('onclick').includes(`'${type}'`)) {
                    btn.classList.add('active');
                }
            });

            // CSS èƒŒæ™¯
            document.getElementById('bg-layer').style.backgroundImage = `url('${config.bg}')`;
            document.getElementById('overlay').style.background = config.overlay;

            // 3D ç¯å¢ƒè¿‡æ¸¡
            new TWEEN.Tween(ambientLight.color).to(new THREE.Color(config.ambient), 1000).start();
            new TWEEN.Tween(dirLight.color).to(new THREE.Color(config.dirColor), 1000).start();
            new TWEEN.Tween(scene.fog.color).to(new THREE.Color(config.fog), 1000).start();
            
            // ç½‘æ ¼å¯è§æ€§è°ƒæ•´ (åŸå¸‚åœºæ™¯æ˜¾ç¤ºæ˜æ˜¾ä¸€ç‚¹ï¼Œè‡ªç„¶åœºæ™¯å‡ ä¹éšè—)
            const targetGridOpacity = (type === 'city') ? 0.2 : 0.05;
            new TWEEN.Tween(gridHelper.material).to({ opacity: targetGridOpacity }, 1000).start();
            
            // é›¾æµ“åº¦
            const targetFog = { density: scene.fog.density };
            new TWEEN.Tween(targetFog)
                .to({ density: config.fogDensity }, 1000)
                .onUpdate(() => scene.fog.density = targetFog.density)
                .start();
        }

        function onResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function updatePlayer(delta) {
            if (!phoenix) return;

            // 1. è®¡ç®—ç§»åŠ¨æ–¹å‘ (ç›¸å¯¹äºç›¸æœºçš„è§†è§’)
            const moveDirection = new THREE.Vector3(0, 0, 0);
            
            // è·å–ç›¸æœºæ°´å¹³æœå‘
            const cameraForward = new THREE.Vector3();
            camera.getWorldDirection(cameraForward);
            cameraForward.y = 0;
            cameraForward.normalize();

            const cameraRight = new THREE.Vector3();
            cameraRight.crossVectors(cameraForward, new THREE.Vector3(0, 1, 0));

            if (keys.w) moveDirection.add(cameraForward);
            if (keys.s) moveDirection.sub(cameraForward);
            if (keys.a) moveDirection.sub(cameraRight);
            if (keys.d) moveDirection.add(cameraRight);

            // 2. åŠ é€Ÿ/å‡é€Ÿé€»è¾‘
            if (moveDirection.lengthSq() > 0) {
                moveDirection.normalize();
                playerState.speed += playerState.acceleration * delta;
                
                // æ—‹è½¬æ¨¡å‹æœå‘ç§»åŠ¨æ–¹å‘
                const targetRotation = Math.atan2(moveDirection.x, moveDirection.z);
                // å¹³æ»‘æ—‹è½¬
                const rotDelta = (targetRotation - phoenix.rotation.y + Math.PI * 3) % (Math.PI * 2) - Math.PI;
                phoenix.rotation.y += rotDelta * playerState.rotationSpeed * delta;
                
            } else {
                playerState.speed -= playerState.deceleration * delta;
            }

            // é€Ÿåº¦é™åˆ¶
            const currentMaxSpeed = keys.shift ? playerState.maxSpeed * 2 : playerState.maxSpeed;
            playerState.speed = THREE.MathUtils.clamp(playerState.speed, 0, currentMaxSpeed);

            // 3. åº”ç”¨ä½ç§»
            if (playerState.speed > 0) {
                const forward = new THREE.Vector3(0, 0, 1).applyAxisAngle(new THREE.Vector3(0, 1, 0), phoenix.rotation.y);
                const displacement = forward.multiplyScalar(playerState.speed * delta);
                phoenix.position.add(displacement);

                // ç›¸æœºè·Ÿéš (ä¿æŒç›¸å¯¹ä½ç½®)
                camera.position.add(displacement);
                controls.target.add(displacement);
                
                // åœ°é¢ä½ç½®è·Ÿéš (ä¼ªæ— é™åœ°å›¾) - å¯é€‰ï¼Œè¿™é‡Œå…ˆä¸ç§»åŠ¨åœ°é¢ï¼Œè®©ç©å®¶åœ¨æœ‰é™çš„å¤§å¹³é¢è·‘
                // å¦‚æœæƒ³åšçœŸæ­£çš„æ— é™ï¼Œå¯ä»¥è®©åœ°é¢æè´¨ UV æ»šåŠ¨ï¼Œæˆ–è€…ç§»åŠ¨åœ°é¢ Mesh
                // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬è®©åœ°é¢è¶³å¤Ÿå¤§ï¼Œå¹¶è®©ç¯å…‰è·Ÿéš
                dirLight.position.x = phoenix.position.x + 20;
                dirLight.position.z = phoenix.position.z + 20;
            }
            
            // 4. æ‚¬æµ®åŠ¨ç”»å åŠ 
            const time = clock.getElapsedTime();
            phoenix.position.y = Math.sin(time * 2) * 0.5; // ä¸Šä¸‹æ‚¬æµ®
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            
            if(mixer) mixer.update(delta);
            
            updatePlayer(delta);
            controls.update();
            TWEEN.update();

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>